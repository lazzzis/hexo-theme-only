{"title":"Python 对函数默认参数的处理","slug":"default-para-in-python","date":"2017-01-16T12:13:49.000Z","updated":"2017-07-30T05:48:51.000Z","comments":true,"excerpt":"","content":"<p>Python 对函数默认参数的处理</p>\n<p>一个以可变对象为默认参数的函数:</p>\n\n    <pre><code class=\"lang-Python\"><span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">A</span>:</span>\n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">def</span> <span class=\"hljs-title\">__init__</span><span class=\"hljs-params\">(self)</span>:</span>\n        self.x = <span class=\"hljs-number\">1</span>\n        print(<span class=\"hljs-string\">'created'</span>)\n\n<span class=\"hljs-function\"><span class=\"hljs-keyword\">def</span> <span class=\"hljs-title\">f</span><span class=\"hljs-params\">(a = A<span class=\"hljs-params\">()</span>)</span>:</span>\n    a.x += <span class=\"hljs-number\">1</span>\n    print(a.x)\n<span class=\"hljs-comment\"># output: created</span>\nf() <span class=\"hljs-comment\"># output: 2</span>\nf() <span class=\"hljs-comment\"># output: 3</span>\n</code></pre>\n<p>从结果可以看出，Python 在解析时便已经创建好了默认参数 a 的值。函数 f 在调用时采用了同一个对象，而不是每次调用时重新创建新的对象。这一点与 <code>C++</code> 的处理方式不同。</p>\n<h1 id=\"f-defaults\"><a href=\"#f-defaults\" class=\"headerlink\" title=\"f.__defaults__\"></a><code>f.__defaults__</code></h1><p>在 Python 中，函数属于一等公民(first-class)。函数可当作一个对象，拥有自己的属性与方法。而默认参数则存在与函数的一个属性中。</p>\n\n    <pre><code class=\"lang-Python\"><span class=\"hljs-selector-tag\">In</span> <span class=\"hljs-selector-attr\">[28]</span>: <span class=\"hljs-selector-tag\">def</span> <span class=\"hljs-selector-tag\">f</span>(a, b=<span class=\"hljs-number\">1</span>):\n       <span class=\"hljs-selector-tag\">2</span>     <span class=\"hljs-selector-tag\">pass</span>\n\n\n<span class=\"hljs-selector-tag\">In</span> <span class=\"hljs-selector-attr\">[29]</span>: <span class=\"hljs-selector-tag\">f</span><span class=\"hljs-selector-class\">.__defaults__</span>\n<span class=\"hljs-selector-tag\">Out</span><span class=\"hljs-selector-attr\">[29]</span>: (<span class=\"hljs-number\">1</span>, [])\n</code></pre>\n<p>Python 在解析代码时，便会将默认参数存于 <code>f.__defaults__</code> 中。</p>\n<p>在 CPython 的 (funcobject.h)[<a href=\"https://github.com/python/cpython/blob/master/Include/funcobject.h\" target=\"_blank\" rel=\"external\">https://github.com/python/cpython/blob/master/Include/funcobject.h</a>] 中也可以看到，<code>PyFunctionObject</code> 的一个属性便是 <code>func_defaults</code>, 对应 Python 中每个函数中的 <code>__defaults__</code> 属性</p>\n<h1 id=\"默认参数-与-闭包\"><a href=\"#默认参数-与-闭包\" class=\"headerlink\" title=\"默认参数 与 闭包\"></a>默认参数 与 闭包</h1><p>以下是一个经常被提起的关于理解闭包的一段代码</p>\n\n    <pre><code class=\"lang-python\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">def</span> <span class=\"hljs-title\">test</span><span class=\"hljs-params\">()</span>:</span>\n    lst = []\n    <span class=\"hljs-keyword\">for</span> i <span class=\"hljs-keyword\">in</span> range(<span class=\"hljs-number\">5</span>):\n        lst.append(<span class=\"hljs-keyword\">lambda</span> x: x * i)\n    <span class=\"hljs-keyword\">return</span> lst\n\n\nlst = test()\n[f(<span class=\"hljs-number\">1</span>) <span class=\"hljs-keyword\">for</span> f <span class=\"hljs-keyword\">in</span> lst]\n<span class=\"hljs-comment\"># Output: [4, 4, 4, 4, 4]</span>\n</code></pre>\n<p>在这里中，匿名函数中的变量 <code>i</code> 并没有在声明时便被求值，而是在匿名函数被调用时才被求值。因为 <code>i</code> 来自于 <code>test</code> 函数，且在匿名函数被调用时，循环已经结束，所以 <code>i</code> 的值已经变成 4。</p>\n<p>但如果想让 <code>i</code> 在匿名函数声明时便被求值该如何做呢？<br>以下代码便借助默认参数解决问题:</p>\n\n    <pre><code class=\"lang-python\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">def</span> <span class=\"hljs-title\">test</span><span class=\"hljs-params\">()</span>:</span>\n    lst = []\n    <span class=\"hljs-keyword\">for</span> i <span class=\"hljs-keyword\">in</span> range(<span class=\"hljs-number\">5</span>):\n        lst.append(<span class=\"hljs-keyword\">lambda</span> x, i=i: x * i)\n    <span class=\"hljs-keyword\">return</span> lst\n\nlst = test()\n\n[f(<span class=\"hljs-number\">1</span>) <span class=\"hljs-keyword\">for</span> f <span class=\"hljs-keyword\">in</span> lst]\n<span class=\"hljs-comment\"># Output: [0, 1, 2, 3, 4]</span>\n</code></pre>\n<p>与第一段代码相比，第二段代码中的 <code>i</code> 在匿名函数声明时就被求值，而且因此，每个匿名函数拥有的默认参数 <code>i</code> 的值都不相同。这样解决了问题。</p>\n<h1 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h1><ol>\n<li><a href=\"https://github.com/python/cpython/blob/master/Include/funcobject.h\" target=\"_blank\" rel=\"external\">funcobject.h</a></li>\n<li><a href=\"http://stackoverflow.com/questions/10120974/where-is-the-default-parameter-in-python-function\" target=\"_blank\" rel=\"external\">Where is the default parameter in Python function</a></li>\n<li><a href=\"http://effbot.org/zone/default-values.htm\" target=\"_blank\" rel=\"external\">Default Parameter Values in Python</a></li>\n</ol>\n","categories":[],"tags":[{"name":"Python","path":"api/tags/Python.json"}]}